var k=Object.defineProperty;var S=(t,e,r)=>e in t?k(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var n=(t,e,r)=>(S(t,typeof e!="symbol"?e+"":e,r),r),g=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var m=(t,e,r)=>(g(t,e,"read from private field"),r?r.call(t):e.get(t)),w=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)},v=(t,e,r,o)=>(g(t,e,"write to private field"),o?o.call(t,r):e.set(t,r),r);var _=(t,e,r)=>(g(t,e,"access private method"),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const d of i.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&o(d)}).observe(document,{childList:!0,subtree:!0});function r(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=r(s);fetch(s.href,i)}})();var c,f,x;class R{constructor(e){w(this,f);n(this,"username","");n(this,"currentRoomID","");n(this,"x",0);n(this,"y",0);n(this,"style","orange");n(this,"usernameStyle","white");n(this,"width",20);n(this,"height",20);n(this,"speed",10);n(this,"direction",0);w(this,c,{x:0,y:0});this.username=e}initInputEvents(){document.addEventListener("keydown",e=>{_(this,f,x).call(this,e.key,!0)}),document.addEventListener("keyup",e=>{_(this,f,x).call(this,e.key,!1)})}setRoomID(e){return this.currentRoomID===""?(this.currentRoomID=e,!0):!1}move(){this.x+=m(this,c).x*this.speed,this.y+=m(this,c).y*this.speed}setPosition(e,r){this.x=e,this.y=r}draw(e,r,o,s){const i=new Path2D,d={x:s.x-r/2,y:s.y-o/2},h={x:this.x-d.x,y:this.y-d.y};return e.strokeStyle=this.style,i.moveTo(h.x-this.width/2,h.y+this.height/2),i.lineTo(h.x,h.y-this.height/2),i.lineTo(h.x+this.width/2,h.y+this.height/2),i.closePath(),e.stroke(i),e.fillStyle=this.usernameStyle,e.fillText(this.username,h.x,h.y-this.height-12),i}setInputAxis(e,r){v(this,c,{x:e,y:r})}get currentRoomID(){return this.currentRoomID}}c=new WeakMap,f=new WeakSet,x=function(e,r){switch(e){case"ArrowUp":m(this,c).y=r?-1:0;break;case"ArrowDown":m(this,c).y=r?1:0;break;case"ArrowLeft":m(this,c).x=r?-1:0;break;case"ArrowRight":m(this,c).x=r?1:0;break}};class T{constructor(e,r=1e3,o=1e3){n(this,"ID");n(this,"width");n(this,"height");n(this,"players",{});n(this,"max_players_amount",2);n(this,"start_timestamp");this.start_timestamp=Date.now(),this.ID=e,this.width=r,this.height=o}get ID(){return this.ID}get start_timestamp(){return this.start_timestamp}get players_amount(){return Object.keys(this.players).length}get is_full(){return this.max_players_amount<=this.players_amount}get_free_room_position(){return{x:this.width/2,y:this.height/2}}add_player(e){if(!this.player_is_here(e.username)){const r=this.get_free_room_position();return e.setPosition(r.x,r.y),this.players[e.username]=e,!0}return!1}remove_player(e){this.player_is_here(e)&&delete this.players[e]}player_is_here(e){return Object.keys(this.players).indexOf(e)!==-1}get_player(e){return this.player_is_here(e)&&this.players[e]}}const O="http://localhost:6600",P=document.getElementById("loginForm"),L=P.querySelector(".error"),D=document.querySelector(".welcomeMessage"),u=document.getElementById("app"),p=u.getContext("2d");let a,l,y;function j(){P.addEventListener("submit",t=>{t.preventDefault(),u.focus();const e=t.target.elements[0].value;fetch(`${O}/login?player_email=${encodeURIComponent(e)}`).then(r=>{r.json().then(o=>{(o==null?void 0:o.status)===200?(l=Object.assign(new T(o.data.ID),structuredClone(o.data)),a=Object.assign(new R(e),structuredClone(l.players[e])),E(),document.addEventListener("keydown",s=>{if(s.key==="Escape"){clearInterval(y);return}}),a.initInputEvents(),window.addEventListener("beforeunload",()=>{y&&(fetch(I("logout")),clearInterval(y))}),D.innerHTML="Welcome, "+e,y=setInterval(M,1e3/60)):(D.innerHTML="Login failed, try again later",clearInterval(y),console.error(o))})})})}function I(t){return`${O}/${t}?player_email=${a.username}&room_id=${a.currentRoomID}`}function A(){fetch(I("room")).then(t=>{t.json().then(e=>{(e==null?void 0:e.status)===200?(l=Object.assign(l,e.data),E()):(L.classList.add("active"),L.innerHTML=e.error,clearInterval(y))})})}function E(){for(const t in l.players){const e=new R(t);l.players[t]=Object.assign(e,l.players[t])}}function q(){const t=new Request(I("player_update"),{method:"POST",body:JSON.stringify({action:"player_update",params:a})});fetch(t)}function M(){A(),a.move(),q(),$()}function $(){p.clearRect(0,0,u.width,u.height),a.draw(p,u.width,u.height,a);for(const t in l.players)t!==a.username&&l.players[t].draw(p,u.width,u.height,a);p.strokeStyle="white",p.strokeRect(-a.x,-a.y,l.width,l.height)}j();
